## ğŸŒ¼ğŸŒ¼ğŸŒ¼å»ºæ ‘ğŸŒ¼ğŸŒ¼ğŸŒ¼

# éœ€è¦è½¯ä»¶trimalã€macseã€translatorxã€samtoolsã€seqkitã€iqtreeã€mafft
# translatorxè¿™ä¸ªæ–‡ä»¶è¿™ä¸ªä»£ç è°ƒæ•´è¿‡ï¼Œè¯·æ›¿æ¢

## ğŸŒ¼ğŸŒ¼ğŸŒ¼å•ä¸ªåŸºå› å»ºæ ‘ğŸŒ¼ğŸŒ¼ğŸŒ¼
conda activate trans_iqtree
translatorx -i COI.final.fa -o COI.transx -p F -c 2 # æŒ‰ç…§ç¼–ç çš„æ°¨åŸºé…¸è¿›è¡Œåºåˆ—æ¯”å¯¹
java -jar /data01/xush/0.software/macse_v2.07.jar -prog exportAlignment -align COI.transx.nt_ali.fasta -codonForInternalStop NNN -codonForFinalStop --- -gc_def 02 # å¯¹ç»ˆæ­¢å¯†ç å­è¿›è¡Œæ ‡æ³¨ï¼Œåé¢æ˜¯å¯¹ç”Ÿæˆçš„NTæ–‡ä»¶å»ºç«‹ç´¢å¼•

samtools faidx COI.transx.nt_ali_NT.fasta # å¯¹ç”Ÿæˆçš„fastaæ–‡ä»¶å»ºç«‹ç´¢å¼•
# åˆ†partitionæ„å»ºçº¿ç²’ä½“è›‹ç™½ç¼–ç åŸºå› ç³»ç»Ÿå‘ç”Ÿæ ‘
# åˆ¶ä½œä¸€ä¸ªpartition fileï¼Œå‚è€ƒå¦‚ä¸‹å‘½ä»¤ï¼Œå°†æ¯ä¸ªæ°¨åŸºé…¸çš„ç¬¬1ä¸ªç¢±åŸºã€ç¬¬2ä¸ªç¢±åŸºã€ç¬¬3ä¸ªç¢±åŸºåˆ†æˆä¸åŒçš„partition
cat mito_gene_list | while read gene; do echo ${gene}; head -n 1 ${gene}.transx.nt_ali_NT.fasta.fai | awk '{print $2}'; done | paste - - | awk 'BEGIN{tot=0; line=0} {print "DNA, part"line*3+1" = "tot+1"-"tot+$2"\\3\n""DNA, part"line*3+2" = "tot+2"-"tot+$2"\\3\n""DNA, part"line*3+3" = "tot+3"-"tot+$2"\\3";tot=tot+$2;line+=1}' > partition.file

# å»ºæ ‘
iqtree -s COI.transx.nt_ali_NT.fasta --seed 6574744 -T 5 -m MFP+MERGE -B 1000 --prefix cdstest -p partition.file
# å¾—åˆ°çš„ç»“æœæ–‡ä»¶ä¸­.contree å’Œ.treefile æ–‡ä»¶ä¸‹è½½ä¸‹æ¥ï¼Œç”¨FigTreeè½¯ä»¶/iTOLç½‘ç«™çœ‹


## ğŸŒ¼ğŸŒ¼ğŸŒ¼13ä¸ªç¼–ç åŸºå› å»ºæ ‘ğŸŒ¼ğŸŒ¼ğŸŒ¼
å…ˆæ„å»ºäº†ä¸€ä¸ª13.gene.listï¼Œç„¶åæŒ‰ç…§13ä¸ªè›‹ç™½å»æå–åºåˆ—
# å…ˆè¯»å…¥ 13.gene.list
GENES=$(cat 13.gene.list | tr -d '>') # éå†æ¯ä¸ª_genes.faæ–‡ä»¶
for file in *_genes.fa; do
    tag=$(basename "$file" _genes.fa) # æå–ç‰©ç§åä½œä¸ºæ ‡ç­¾
    out="${tag}_filtered_genes.fa"
    awk -v genes="$GENES" -v tag="$tag" '
        BEGIN{
            n=split(genes, arr, "\n")
            for(i=1; i<=n; i++) keep[arr[i]]=1
        }
        /^>/ {
            split($0, a, " ")
            gsub(/^>/, "", a[1])
            gene=a[1]
            if (keep[gene]) {
                print ">"gene"_"tag
                keep_seq=1
            } else {
                keep_seq=0
            }
            next
        }
        keep_seq { print }
    ' "$file" > "$out"
done  ## å¾—åˆ°çš„æ˜¯æ³¨é‡Šäº†13ä¸ªè›‹ç™½çš„filtered_genes.fa


# æå–æ‰€æœ‰COXIIIçš„åºåˆ—
gene="COXIII"
rm -f ${gene}_all.fa  # é˜²æ­¢è¿½åŠ æ±¡æŸ“

for file in *.fa; do
    awk -v g="^>"$gene"_" '
        $0 ~ g {p=1; print; next}   # ç¢°åˆ°ç›®æ ‡æ ‡é¢˜ï¼Œå¼€å¯å¼€å…³å¹¶æ‰“å°
        /^>/ {p=0}                  # é‡åˆ°æ–°æ ‡é¢˜ï¼Œå…³é—­å¼€å…³
        p                           # å¦‚æœå¼€å…³å¼€å¯ï¼Œæ‰“å°è¡Œ
    ' "$file" >> ${gene}_all.fa
done

cat mito_gene_list | while read gene; do \
  translatorx -i ${gene}.fa -o ${gene}.transx -p F -c 2; \
  java -jar /data01/xush/0.software/macse_v2.07.jar -prog exportAlignment -align ${gene}.transx.nt_ali.fasta -codonForInternalStop NNN -codonForFinalStop --- -gc_def 02; \
  trimal -in ${gene}.transx.nt_ali_NT.fasta -out ${gene}.transx.macse.trimal -automated1; \
  translatorx -i ${gene}.transx.macse.trimal -o ${gene}.transx.macse.trimal.transx.fasta -p F -c 2; \
  java -jar /data01/xush/0.software/macse_v2.07.jar -prog exportAlignment -align ${gene}.transx.macse.trimal.transx.fasta.nt_ali.fasta -codonForInternalStop NNN -codonForFinalStop --- -gc_def 02; \
done

# æ³¨æ„å¯¹ç”Ÿæˆçš„æ¯”å¯¹æ–‡ä»¶è¿›è¡Œæ£€æŸ¥ï¼Œæ¯”å¦‚æ¯”å¯¹æ˜¯å¦æœ‰å¼‚å¸¸ï¼Œé•¿åº¦æ˜¯å¦æ­£å¸¸
# æ­¤å¤„éœ€è¦ä¿®æ”¹æ–‡ä»¶é‡Œçš„IDå,å°†æ¯ä¸ªåŸºå› æ–‡ä»¶ä¸­çš„æ¯ä¸ªæ ·æœ¬åæ”¹æˆä¸€æ ·çš„ï¼Œåé¢æ‰èƒ½ä¸²è”åˆ°ä¸€èµ·


#####
# å¯¹ç”Ÿæˆçš„fastaæ–‡ä»¶å»ºç«‹ç´¢å¼•
cat mito_gene_list| while read gene; do samtools faidx ${gene}.transx.macse.trimal.transx.fasta.nt_ali_NT.fasta; done

# mito_gene_listæ–‡ä»¶åˆ—å‡ºçº¿ç²’ä½“åŸºå› å
cat mito_gene_list| while read gene; do ls ${gene}.transx.macse.trimal.transx.fasta.nt_ali_NT.fasta; done > infile.list

# å°†å„ä¸ªåŸºå› çš„alignmentä¸²è”åˆ°ä¸€èµ·
seqkit concat --infile-list infile.list --out-file concat.fasta

# åˆ†partitionæ„å»ºçº¿ç²’ä½“è›‹ç™½ç¼–ç åŸºå› ç³»ç»Ÿå‘ç”Ÿæ ‘
# åˆ¶ä½œä¸€ä¸ªpartition fileï¼Œå‚è€ƒå¦‚ä¸‹å‘½ä»¤ï¼Œå°†æ¯ä¸ªæ°¨åŸºé…¸çš„ç¬¬1ä¸ªç¢±åŸºã€ç¬¬2ä¸ªç¢±åŸºã€ç¬¬3ä¸ªç¢±åŸºåˆ†æˆä¸åŒçš„partition
cat mito_gene_list | while read gene; do echo ${gene}; head -n 1 ${gene}.transx.macse.trimal.transx.fasta.nt_ali_NT.fasta.fai | awk '{print $2}'; done | paste - - | awk 'BEGIN{tot=0; line=0} {print "DNA, part"line*3+1" = "tot+1"-"tot+$2"\\3\n""DNA, part"line*3+2" = "tot+2"-"tot+$2"\\3\n""DNA, part"line*3+3" = "tot+3"-"tot+$2"\\3";tot=tot+$2;line+=1}' > partition.file
# å»ºæ ‘
source activate iqtree
iqtree -s concat.fasta --seed 6574744 -T 5 -m MFP+MERGE -B 1000 --prefix cdstest -p partition.file

# å¾—åˆ°çš„ç»“æœæ–‡ä»¶ä¸­.contree å’Œ.treefile æ–‡ä»¶ä¸‹è½½ä¸‹æ¥ï¼Œç”¨FigTreeè½¯ä»¶/iTOLç½‘ç«™çœ‹
